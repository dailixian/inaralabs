/**
 * Copyright @ 2024 Esri.
 * All rights reserved under the copyright laws of the United States and applicable international laws, treaties, and conventions.
 */
define(["dojo/_base/declare","esri/geometry/support/centroid","../../webgl-engine-extensions/earcut","esri/core/libs/gl-matrix-2/vec3f64","esri/core/libs/gl-matrix-2/vec3","../../support/geometryUtils","esri/geometry/support/triangulationUtils","esri/geometry/projection","esri/geometry/projection/projectBuffer"],function(t,e,n,i,r,p,s,o,a){function d(t,e){var n=s.pathsToTriangulationInfo(t,e);return{vertexData:n.position,polygons:n.polygons,outlines:n.outlines}}function h(t,e,n,i,r,p,s){return a.projectBuffer(t,n,e,i,p,r,s)}var u=i.vec3f64,r=r.vec3,c=u.create(),l=u.create(),x=u.create(),f=u.create(),g=u.create(),v=u.create(),m=u.create(),y=u.create(),_=6378137,b={Down:0,Up:1},D=Math.cos(5*(Math.PI/180)),E=100.11,w=t(null,{constructor:function(t,n,i){var r=t.geometry.rings,p={rings:r,hasZ:!1};this.center=e.polygonCentroid(p),this._geometryData=d(r,t.geometry.hasZ),this._geometryData&&n>=0&&i>=0&&(this.index=n,this.stride=i)},createBuffers:function(t,e){var i,r,s,o,a,d,u,c,l=this._geometryData.polygons,x=[],f=this._geometryData.vertexData;if(!f)return x;var g=f.length/3,v=new Float64Array(f.length);h(f,0,t,v,0,e,g);for(var m=new Float64Array(v),y=0;y<l.length;++y){i=l[y],u=i.count,c=i.index;var _=new Float64Array(f.buffer,3*c*f.BYTES_PER_ELEMENT,3*u);if(r=i.holeIndices.map(function(t){return t-c}),s=n(_,r,3),!(s.length<1)){var D={polygonIndex:y},w=new Float64Array(m.buffer,3*c*m.BYTES_PER_ELEMENT,3*u),U=this._computeNormalAndDistance(w);D.dist=U.distance;var z=p.getOrigin(v,g,c,u);if(z){D.origin=z;var A=[],N=[];o=i.count,a=2*o;for(var M=0;M<o;M++)d=M*this.stride,A[0+d]=_[0+3*M],A[1+d]=_[1+3*M],A[2+d]=1,A[3+d]=this.index,A[4+d]=b.Down,A[5+d]=this.center[0],A[6+d]=this.center[1],d=(M+o)*this.stride,A[0+d]=_[0+3*M],A[1+d]=_[1+3*M],A[2+d]=E,A[3+d]=this.index,A[4+d]=b.Up,A[5+d]=this.center[0],A[6+d]=this.center[1];for(var j=0,F=0,T=0;T<i.pathLengths.length;T++){F=i.pathLengths[T];for(var B=0;B<F;B++)B!==F-1?N.push(B+1+j,B+j,B+1+o+j,B+1+o+j,B+j,B+o+j):N.push(0+j,B+j,0+o+j,0+o+j,B+j,B+o+j);j+=F}this._subdivision2(_,w,s,o,A,N),D.indexNums=N.length,D.vertexNum=A.length/this.stride,D.vertices=new Float32Array(A),D.indices=new Uint32Array(N),x.push(D)}}}return x},_computeNormalAndDistance:function(t){var e=0,n=3,i=6;r.set(c,t[e++],t[e++],t[e++]),r.set(l,t[n++],t[n++],t[n++]),r.set(x,t[i++],t[i++],t[i++]),r.subtract(f,c,l),r.subtract(g,x,l);var p=u.create();r.cross(p,f,g),r.normalize(p,p);var s=Math.abs(r.dot(p,c)),o=_-s,a=r.normalize(c,c),d=r.dot(p,a),h=Math.abs(o/d);return{normal:p,distance:h}},_subdivision:function(t,e,n,i,r,p){for(var s,o,a,d,h,u,c,l,x=e.length/3,f=0,g=0,v=0;v<x;v++)d=e[f++],h=e[f++],u=e[f++],s=3*d,o=3*h,a=3*u,c=(t[s]+t[o]+t[a])/3,l=(t[s+1]+t[o+1]+t[a+1])/3,r.push(c,l,E,this.index,b.Up,this.center[0],this.center[1]),p.push(d+n,h+n,i+g),p.push(h+n,u+n,i+g),p.push(u+n,d+n,i+g),g++},_doSubdivision:function(t,e,n){if(t.length>0)for(var i,p,s,o,a,d,h,c,l,x,f=-1,g=e.length/this.stride;null!=(i=t.pop());)if(r.copy(v,i.pt0),r.copy(m,i.pt1),r.copy(y,i.pt2),i.n0||(i.n0=u.create(),r.normalize(i.n0,v)),i.n1||(i.n1=u.create(),r.normalize(i.n1,m)),i.n2||(i.n2=u.create(),r.normalize(i.n2,y)),p=r.dot(i.n0,i.n1),s=r.dot(i.n1,i.n2),o=r.dot(i.n0,i.n2),p<D||s<D||o<D){if(a=Math.min(p,s,o),!isNaN(a)&&null!=a)if(a==p){f++,d=.5*(v[0]+m[0]),h=.5*(v[1]+m[1]),c=.5*(v[2]+m[2]),l=.5*(i.pt00[0]+i.pt11[0]),x=.5*(i.pt00[1]+i.pt11[1]);var _=u.fromValues(d,h,c);r.normalize(_,_),t.push({pt0:i.pt0,pt1:[d,h,c],pt2:i.pt2,pt00:i.pt00,pt11:[l,x],pt22:i.pt22,index0:i.index0,index1:g+f,index2:i.index2,n0:i.n0,n1:_,n2:i.n2}),t.push({pt0:[d,h,c],pt1:i.pt1,pt2:i.pt2,pt00:[l,x],pt11:i.pt11,pt22:i.pt22,index0:g+f,index1:i.index1,index2:i.index2,n0:_,n1:i.n1,n2:i.n2}),e.push(l,x,E,this.index,b.Up,this.center[0],this.center[1]),n.push(g+f,i.index0,i.index1)}else if(a==s){f++,d=.5*(m[0]+y[0]),h=.5*(m[1]+y[1]),c=.5*(m[2]+y[2]),l=.5*(i.pt22[0]+i.pt11[0]),x=.5*(i.pt22[1]+i.pt11[1]);var _=u.fromValues(d,h,c);r.normalize(_,_),t.push({pt0:i.pt0,pt1:i.pt1,pt2:[d,h,c],pt00:i.pt00,pt11:i.pt11,pt22:[l,x],index0:i.index0,index1:i.index1,index2:g+f,n0:i.n0,n1:i.n1,n2:_}),t.push({pt0:i.pt0,pt1:[d,h,c],pt2:i.pt2,pt00:i.pt00,pt11:[l,x],pt22:i.pt22,index0:i.index0,index1:g+f,index2:i.index2,n0:i.n0,n1:_,n2:i.n2}),e.push(l,x,E,this.index,b.Up,this.center[0],this.center[1]),n.push(g+f,i.index1,i.index2)}else if(a==o){f++,d=.5*(v[0]+y[0]),h=.5*(v[1]+y[1]),c=.5*(v[2]+y[2]),l=.5*(i.pt22[0]+i.pt00[0]),x=.5*(i.pt22[1]+i.pt00[1]);var _=u.fromValues(d,h,c);r.normalize(_,_),t.push({pt0:i.pt0,pt1:i.pt1,pt2:[d,h,c],pt00:i.pt00,pt11:i.pt11,pt22:[l,x],index0:i.index0,index1:i.index1,index2:g+f,n0:i.n0,n1:i.n1,n2:_}),t.push({pt0:[d,h,c],pt1:i.pt1,pt2:i.pt2,pt00:[l,x],pt11:i.pt11,pt22:i.pt22,index0:g+f,index1:i.index1,index2:i.index2,n0:_,n1:i.n1,n2:i.n2}),e.push(l,x,E,this.index,b.Up,this.center[0],this.center[1]),n.push(g+f,i.index2,i.index0)}}else n.push(i.index0,i.index1,i.index2)},_subdivision2:function(t,e,n,i,r,p){for(var s,o,a,d,h,u,c=n.length/3,l=0,x=0;x<c;x++)d=n[l++],h=n[l++],u=n[l++],s=3*d,o=3*h,a=3*u,this._doSubdivision([{pt0:[e[s],e[s+1],e[s+2]],pt1:[e[o],e[o+1],e[o+2]],pt2:[e[a],e[a+1],e[a+2]],pt00:[t[s],t[s+1]],pt11:[t[o],t[o+1]],pt22:[t[a],t[a+1]],index0:d+i,index1:h+i,index2:u+i}],r,p)},destroy:function(){this.isFulfilled()||this.reject()}});return w});